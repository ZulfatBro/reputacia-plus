<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameTalk - Геймерский P2P чат</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --dark-bg: #1e1f29;
            --darker-bg: #171820;
            --channel-bg: #2f3136;
            --channel-hover: #34373c;
            --text-primary: #ffffff;
            --text-secondary: #b9bbbe;
            --accent: #5865f2;
            --accent-hover: #4752c4;
            --online: #3ba55d;
            --idle: #faa81a;
            --dnd: #ed4245;
            --message-bg: #36393f;
            --input-bg: #40444b;
            --success: #43b581;
            --error: #f04747;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Панель друзей */
        .friends-panel {
            width: 260px;
            background-color: var(--darker-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--channel-bg);
        }

        .panel-header {
            padding: 16px;
            border-bottom: 1px solid var(--channel-bg);
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-header i {
            margin-right: 8px;
        }

        .panel-title {
            display: flex;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--channel-bg);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            position: relative;
        }

        .user-status {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--online);
            border: 2px solid var(--darker-bg);
            bottom: 0;
            right: 0;
        }

        .username {
            font-size: 14px;
            font-weight: 600;
        }

        .user-id {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .friend {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .friend:hover {
            background: var(--channel-hover);
        }

        .friend.active {
            background: var(--channel-hover);
        }

        .friend-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 14px;
            position: relative;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-size: 14px;
        }

        .friend-status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .friend-online {
            color: var(--online);
        }

        .friend-idle {
            color: var(--idle);
        }

        .friend-dnd {
            color: var(--dnd);
        }

        .friend-status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-online {
            background: var(--online);
        }

        .status-idle {
            background: var(--idle);
        }

        .status-dnd {
            background: var(--dnd);
        }

        .add-friend-container {
            padding: 16px;
            border-top: 1px solid var(--channel-bg);
        }

        .add-friend-input {
            width: 100%;
            padding: 10px;
            background: var(--input-bg);
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .add-friend-input:focus {
            outline: 2px solid var(--accent);
        }

        .add-friend-btn {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            background: var(--accent);
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .add-friend-btn:hover {
            background: var(--accent-hover);
        }

        /* Область чата */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--channel-bg);
            display: flex;
            align-items: center;
        }

        .chat-header-info {
            margin-left: 12px;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-status {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .messages-container {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png') var(--dark-bg);
        }

        .message {
            display: flex;
            margin-bottom: 16px;
            max-width: 80%;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 18px;
            position: relative;
        }

        .status {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--online);
            border: 2px solid var(--darker-bg);
            bottom: 0;
            right: 0;
        }

        .status.idle {
            background: var(--idle);
        }

        .status.dnd {
            background: var(--dnd);
        }

        .message-content {
            background: var(--message-bg);
            border-radius: 8px;
            padding: 8px 16px;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
        }

        .username {
            font-weight: 600;
            margin-right: 8px;
        }

        .timestamp {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .message-text {
            line-height: 1.4;
        }

        .own-message {
            align-self: flex-end;
        }

        .own-message .message-content {
            background: var(--accent);
        }

        .own-message .message {
            flex-direction: row-reverse;
        }

        .own-message .avatar {
            margin-right: 0;
            margin-left: 16px;
        }

        .system-message {
            align-self: center;
            background: rgba(114, 137, 218, 0.1);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            color: var(--text-secondary);
            margin: 8px 0;
        }

        .connection-status {
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.3);
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .connected {
            background: var(--online);
        }

        .connecting {
            background: var(--idle);
        }

        .disconnected {
            background: var(--dnd);
        }

        /* Панель ввода сообщения */
        .input-container {
            padding: 16px;
            background: var(--channel-bg);
        }

        .message-input {
            width: 100%;
            background: var(--input-bg);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 16px;
            resize: none;
            height: 44px;
            max-height: 200px;
        }

        .message-input:focus {
            outline: none;
        }

        /* Панель регистрации/входа */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .auth-box {
            background: var(--darker-bg);
            border-radius: 8px;
            width: 480px;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .auth-header h2 {
            margin-bottom: 8px;
            font-size: 26px;
            background: linear-gradient(90deg, #5865f2, #eb459e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-header p {
            color: var(--text-secondary);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            background: var(--channel-bg);
            border-radius: 4px;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .auth-tab.active {
            background: var(--accent);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background: var(--input-bg);
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .input-group input:focus {
            outline: 2px solid var(--accent);
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .auth-button:hover {
            background: var(--accent-hover);
        }

        .close-auth {
            position: absolute;
            top: 16px;
            right: 16px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
        }

        /* Уведомления */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 4px;
            background: var(--darker-bg);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            margin-right: 8px;
            font-size: 18px;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--error);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .friends-panel {
                width: 60px;
            }
            
            .friends-panel .user-info .username,
            .friends-panel .friend-info,
            .friends-panel .add-friend-container {
                display: none;
            }
            
            .friends-panel .panel-header span {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Панель друзей -->
        <div class="friends-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-gamepad"></i>
                    <span>GameTalk</span>
                </div>
                <i class="fas fa-cog"></i>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">
                    <span id="userInitials">U</span>
                    <div class="user-status online"></div>
                </div>
                <div>
                    <div class="username" id="usernameDisplay">Username</div>
                    <div class="user-id" id="userIdDisplay">ID: loading...</div>
                </div>
            </div>
            
            <div class="friends-list" id="friendsList">
                <!-- Список друзей будет здесь -->
            </div>
            
            <div class="add-friend-container">
                <input type="text" class="add-friend-input" id="friendIdInput" placeholder="Введите ID друга">
                <button class="add-friend-btn" id="addFriendBtn">Добавить друга</button>
            </div>
        </div>
        
        <!-- Область чата -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="avatar small">
                    <span>F</span>
                    <div class="status online"></div>
                </div>
                <div class="chat-header-info">
                    <div class="chat-title" id="currentChatTitle">Выберите друга для общения</div>
                    <div class="chat-status" id="currentChatStatus">Начните общение!</div>
                </div>
            </div>
            
            <div class="connection-status">
                <div class="status-indicator connected" id="connectionStatus"></div>
                <span id="connectionStatusText">Соединение установлено</span>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Сообщения будут здесь -->
            </div>
            
            <div class="input-container">
                <textarea class="message-input" id="messageInput" placeholder="Напишите сообщение..." disabled></textarea>
            </div>
        </div>
    </div>
    
    <!-- Окно регистрации/входа -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="close-auth" id="closeAuth">
                <i class="fas fa-times"></i>
            </div>
            <div class="auth-header">
                <h2>GameTalk</h2>
                <p>Геймерский P2P чат для настоящих фанатов</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Вход</div>
                <div class="auth-tab" id="registerTab">Регистрация</div>
            </div>
            
            <div class="input-group">
                <label for="username">Имя пользователя</label>
                <input type="text" id="username" placeholder="Введите ваш никнейм">
            </div>
            
            <button class="auth-button" id="authButton">Продолжить</button>
        </div>
    </div>
    
    <!-- Уведомления -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationText">Сообщение</span>
    </div>

    <script>
        // Основные переменные
        let peer;
        let currentUser = {
            id: null,
            username: null,
            status: 'online'
        };
        
        let connections = {};
        let friends = {};
        let currentChat = null;
        
        // Элементы DOM
        const authContainer = document.getElementById('authContainer');
        const closeAuth = document.getElementById('closeAuth');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const authButton = document.getElementById('authButton');
        const usernameInput = document.getElementById('username');
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const friendsList = document.getElementById('friendsList');
        const friendIdInput = document.getElementById('friendIdInput');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const userInitials = document.getElementById('userInitials');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentChatTitle = document.getElementById('currentChatTitle');
        const currentChatStatus = document.getElementById('currentChatStatus');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionStatusText = document.getElementById('connectionStatusText');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        
        // Инициализация приложения
        function initApp() {
            // Проверяем, есть ли сохраненный пользователь
            const savedUser = localStorage.getItem('gametalk_user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    currentUser = userData;
                    initPeer();
                    updateUserUI();
                    authContainer.style.display = 'none';
                    loadFriends();
                } catch (e) {
                    showAuth();
                }
            } else {
                showAuth();
            }
        }
        
        // Показать окно авторизации
        function showAuth() {
            authContainer.style.display = 'flex';
        }
        
        // Инициализация Peer.js
        function initPeer() {
            // Генерируем уникальный ID для пользователя
            if (!currentUser.id) {
                currentUser.id = 'user_' + Math.random().toString(36).substr(2, 9);
                saveUserData();
            }
            
            // Инициализируем Peer
            peer = new Peer(currentUser.id, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true
            });
            
            peer.on('open', function(id) {
                console.log('My peer ID is: ' + id);
                currentUser.id = id;
                saveUserData();
                updateUserUI();
                updateConnectionStatus('connected', 'Соединение установлено');
            });
            
            peer.on('connection', function(conn) {
                console.log('Новое входящее соединение от: ' + conn.peer);
                
                // Обработка входящего соединения
                setupConnection(conn);
                
                // Добавляем друга, если он еще не в списке
                if (!friends[conn.peer]) {
                    friends[conn.peer] = {
                        id: conn.peer,
                        username: 'Друг #' + conn.peer.substr(0, 4),
                        status: 'online'
                    };
                    saveFriends();
                    renderFriendsList();
                }
                
                showNotification(`Новое подключение от ${friends[conn.peer].username}`, 'success');
            });
            
            peer.on('error', function(err) {
                console.error('Peer error:', err);
                if (err.type === 'unavailable-id') {
                    // Если ID занят, генерируем новый
                    currentUser.id = null;
                    saveUserData();
                    initPeer();
                } else if (err.type === 'disconnected') {
                    updateConnectionStatus('disconnected', 'Соединение потеряно');
                } else if (err.type === 'network') {
                    updateConnectionStatus('connecting', 'Переподключение...');
                }
            });
            
            peer.on('disconnected', function() {
                updateConnectionStatus('disconnected', 'Соединение потеряно');
                // Пытаемся переподключиться
                setTimeout(() => {
                    peer.reconnect();
                }, 2000);
            });
        }
        
        // Настройка соединения
        function setupConnection(conn) {
            // Добавляем соединение в наш список
            connections[conn.peer] = conn;
            
            // Обработка входящих данных
            conn.on('data', function(data) {
                console.log('Получены данные от ' + conn.peer + ': ', data);
                
                if (data.type === 'message') {
                    displayMessage(data.sender, data.text, false);
                } else if (data.type === 'user-info') {
                    // Обновляем информацию о друге
                    friends[conn.peer] = {
                        id: conn.peer,
                        username: data.username,
                        status: data.status
                    };
                    saveFriends();
                    renderFriendsList();
                    
                    // Если это текущий чат, обновляем заголовок
                    if (currentChat === conn.peer) {
                        updateChatUI();
                    }
                }
            });
            
            conn.on('close', function() {
                console.log('Соединение закрыто с ' + conn.peer);
                if (friends[conn.peer]) {
                    friends[conn.peer].status = 'offline';
                    saveFriends();
                    renderFriendsList();
                    
                    if (currentChat === conn.peer) {
                        currentChatStatus.textContent = 'Друг не в сети';
                    }
                }
            });
            
            conn.on('error', function(err) {
                console.error('Connection error:', err);
            });
            
            // Отправляем информацию о себе
            conn.send({
                type: 'user-info',
                username: currentUser.username,
                status: currentUser.status
            });
        }
        
        // Сохранение данных пользователя
        function saveUserData() {
            localStorage.setItem('gametalk_user', JSON.stringify(currentUser));
            updateUserUI();
        }
        
        // Сохранение списка друзей
        function saveFriends() {
            localStorage.setItem('gametalk_friends', JSON.stringify(friends));
        }
        
        // Загрузка списка друзей
        function loadFriends() {
            const savedFriends = localStorage.getItem('gametalk_friends');
            if (savedFriends) {
                try {
                    friends = JSON.parse(savedFriends);
                    renderFriendsList();
                } catch (e) {
                    friends = {};
                }
            }
        }
        
        // Обновление UI пользователя
        function updateUserUI() {
            userInitials.textContent = currentUser.username ? currentUser.username.charAt(0).toUpperCase() : 'U';
            usernameDisplay.textContent = currentUser.username || 'Username';
            userIdDisplay.textContent = 'ID: ' + (currentUser.id || 'loading...');
        }
        
        // Обновление UI чата
        function updateChatUI() {
            if (currentChat && friends[currentChat]) {
                currentChatTitle.textContent = friends[currentChat].username;
                
                if (connections[currentChat] && connections[currentChat].open) {
                    currentChatStatus.textContent = 'В сети';
                } else {
                    currentChatStatus.textContent = 'Не в сети';
                }
                
                messageInput.disabled = false;
                messageInput.placeholder = `Напишите сообщение ${friends[currentChat].username}...`;
            } else {
                currentChatTitle.textContent = 'Выберите друга для общения';
                currentChatStatus.textContent = 'Начните общение!';
                messageInput.disabled = true;
                messageInput.placeholder = 'Напишите сообщение...';
            }
        }
        
        // Обновление статуса соединения
        function updateConnectionStatus(status, text) {
            connectionStatus.className = 'status-indicator';
            if (status === 'connected') {
                connectionStatus.classList.add('connected');
            } else if (status === 'connecting') {
                connectionStatus.classList.add('connecting');
            } else {
                connectionStatus.classList.add('disconnected');
            }
            connectionStatusText.textContent = text;
        }
        
        // Отображение списка друзей
        function renderFriendsList() {
            friendsList.innerHTML = '';
            
            Object.values(friends).forEach(friend => {
                const friendEl = document.createElement('div');
                friendEl.className = 'friend';
                if (currentChat === friend.id) {
                    friendEl.classList.add('active');
                }
                
                friendEl.innerHTML = `
                    <div class="friend-avatar">
                        <span>${friend.username.charAt(0).toUpperCase()}</span>
                        <div class="status ${friend.status}"></div>
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.username}</div>
                        <div class="friend-status">
                            <span class="friend-status-dot status-${friend.status}"></span>
                            ${friend.status === 'online' ? 'В сети' : 
                              friend.status === 'idle' ? 'Отошёл' : 
                              friend.status === 'dnd' ? 'Не беспокоить' : 'Не в сети'}
                        </div>
                    </div>
                `;
                
                friendEl.addEventListener('click', () => {
                    openChat(friend.id);
                });
                
                friendsList.appendChild(friendEl);
            });
        }
        
        // Открытие чата с другом
        function openChat(friendId) {
            currentChat = friendId;
            
            // Если соединения нет, попытаться подключиться
            if (!connections[friendId] || !connections[friendId].open) {
                connectToFriend(friendId);
            }
            
            updateChatUI();
            renderFriendsList();
            
            // Прокрутить сообщения вниз
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Подключение к другу
        function connectToFriend(friendId) {
            // Проверяем, есть ли уже соединение
            if (connections[friendId] && connections[friendId].open) {
                return;
            }
            
            // Создаем новое соединение
            const conn = peer.connect(friendId);
            
            conn.on('open', function() {
                console.log('Успешное подключение к ' + friendId);
                setupConnection(conn);
                
                if (friends[friendId]) {
                    friends[friendId].status = 'online';
                    saveFriends();
                    renderFriendsList();
                    
                    if (currentChat === friendId) {
                        currentChatStatus.textContent = 'В сети';
                    }
                }
            });
            
            conn.on('error', function(err) {
                console.error('Ошибка подключения к ' + friendId, err);
                showNotification('Не удалось подключиться к другу', 'error');
            });
        }
        
        // Отправка сообщения
        function sendMessage() {
            const text = messageInput.value.trim();
            if (text && currentChat && connections[currentChat]) {
                // Создаем объект сообщения
                const message = {
                    type: 'message',
                    text: text,
                    sender: currentUser.id,
                    timestamp: new Date().toISOString()
                };
                
                // Отправляем через соединение
                connections[currentChat].send(message);
                
                // Отображаем в UI
                displayMessage(currentUser.id, text, true);
                
                // Очищаем поле ввода
                messageInput.value = '';
                messageInput.style.height = '44px';
            }
        }
        
        // Отображение сообщения
        function displayMessage(senderId, text, isOwn) {
            const friend = friends[senderId];
            const senderName = isOwn ? 'Вы' : (friend ? friend.username : 'Неизвестный');
            
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOwn ? 'own-message' : ''}`;
            
            messageEl.innerHTML = `
                <div class="avatar">
                    <span>${senderName.charAt(0).toUpperCase()}</span>
                    <div class="status online"></div>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <div class="username">${senderName}</div>
                        <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                    </div>
                    <div class="message-text">${text}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageEl);
            
            // Прокручиваем к новому сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Показать уведомление
        function showNotification(text, type) {
            notification.className = `notification ${type}`;
            notificationText.textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Обработчики событий
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Обработка аутентификации
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
        });
        
        registerTab.addEventListener('click', () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
        });
        
        closeAuth.addEventListener('click', () => {
            authContainer.style.display = 'none';
        });
        
        authButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username.length < 3) {
                showNotification('Имя пользователя должно быть не менее 3 символов', 'error');
                return;
            }
            
            currentUser.username = username;
            saveUserData();
            updateUserUI();
            initPeer();
            authContainer.style.display = 'none';
        });
        
        // Добавление друга
        addFriendBtn.addEventListener('click', () => {
            const friendId = friendIdInput.value.trim();
            if (!friendId) {
                showNotification('Введите ID друга', 'error');
                return;
            }
            
            if (friendId === currentUser.id) {
                showNotification('Нельзя добавить самого себя', 'error');
                return;
            }
            
            if (friends[friendId]) {
                showNotification('Этот друг уже добавлен', 'error');
                return;
            }
            
            // Добавляем в список друзей
            friends[friendId] = {
                id: friendId,
                username: 'Друг #' + friendId.substr(0, 4),
                status: 'offline'
            };
            
            saveFriends();
            renderFriendsList();
            friendIdInput.value = '';
            
            // Пытаемся подключиться
            connectToFriend(friendId);
            
            showNotification('Друг добавлен', 'success');
        });
        
        // Отправка сообщения
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Автоматическое изменение высоты поля ввода
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    </script>
</body>
</html>
