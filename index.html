<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ù–µ–æ–Ω–æ–≤—ã–π P2P-–∑–≤–æ–Ω–æ–∫ (WebRTC)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');

    body {
      font-family: 'Orbitron', Arial, sans-serif;
      background-color: #0a0a1a;
      color: #00ffcc;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      border: 2px solid #00ffcc;
      border-radius: 15px;
      box-shadow: 0 0 20px #00ffcc, 0 0 40px #00ffcc inset;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(45deg, rgba(0, 255, 204, 0.05), rgba(255, 0, 255, 0.05));
      z-index: -1;
      pointer-events: none;
    }

    h2, h3 {
      color: #00ffaa;
      text-shadow: 0 0 10px #00ffaa, 0 0 20px #00ffaa;
      border-bottom: 2px dashed #00ffaa;
      padding-bottom: 10px;
    }

    h2 {
      font-size: 2em;
      text-align: center;
    }

    h3 {
      font-size: 1.4em;
    }

    .hint {
      color: #ff00ff;
      font-size: 0.9em;
      font-style: italic;
      text-shadow: 0 0 5px #ff00ff;
    }

    textarea {
      width: 100%;
      height: 120px;
      background-color: #0f0f2f;
      color: #00ffcc;
      border: 2px solid #00ffcc;
      border-radius: 10px;
      padding: 10px;
      font-family: monospace;
      box-shadow: 0 0 10px #00ffcc;
      resize: vertical;
      transition: box-shadow 0.3s ease;
    }

    textarea:focus {
      outline: none;
      box-shadow: 0 0 15px #00ffcc, 0 0 25px #00ffcc;
    }

    button {
      background: transparent;
      color: #00ffcc;
      border: 2px solid #00ffcc;
      border-radius: 8px;
      padding: 10px 16px;
      margin: 6px 5px;
      font-family: 'Orbitron', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 5px #00ffcc;
    }

    button:hover {
      background-color: rgba(0, 255, 204, 0.1);
      box-shadow: 0 0 15px #00ffcc, 0 0 25px #00ffcc;
      transform: scale(1.05);
    }

    button:active {
      transform: scale(0.98);
    }

    .row {
      margin-bottom: 15px;
    }

    audio {
      display: block;
      margin-top: 15px;
      width: 100%;
      background-color: #000;
      border-radius: 8px;
      border: 1px solid #00ffcc;
    }

    audio::-webkit-media-controls {
      color: #00ffcc;
    }

    hr {
      border: 1px dashed #00ffcc;
      margin: 25px 0;
      box-shadow: 0 0 5px #00ffcc;
    }

    #micStatus {
      font-size: 0.9em;
      margin-left: 10px;
    }

    #remoteAudioHolder {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 255, 204, 0.05);
      border: 1px solid #00ffaa;
      border-radius: 10px;
    }

    #remoteAudioHolder::before {
      content: "üéß –í—Ö–æ–¥—è—â–∏–π –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫";
      display: block;
      margin-bottom: 10px;
      color: #ff00ff;
      font-weight: bold;
      text-shadow: 0 0 5px #ff00ff;
    }
  </style>
</head>
<body>
  <h2>üåÄ –ù–µ–æ–Ω–æ–≤—ã–π P2P-–∑–≤–æ–Ω–æ–∫ (WebRTC)</h2>
  <div class="hint">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ HTTPS –∏–ª–∏ localhost. –î–ª—è NAT —Ç—Ä–µ–±—É–µ—Ç—Å—è TURN-—Å–µ—Ä–≤–µ—Ä.</div>

  <div class="row">
    <button id="startMic">üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    <span id="micStatus"></span>
  </div>

  <hr>

  <h3>1Ô∏è‚É£ –ó–≤–æ–Ω—è—â–∏–π: –°–æ–∑–¥–∞—Ç—å Offer</h3>
  <div class="row">
    <button id="createOffer">‚ñ∂Ô∏è –°–æ–∑–¥–∞—Ç—å Offer</button>
    <button id="copyOffer">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Offer</button>
  </div>
  <textarea id="offerOut" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è Offer JSON (—Å–∫–æ–ø–∏—Ä—É–π –∏ –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É)"></textarea>

  <hr>

  <h3>2Ô∏è‚É£ –û—Ç–≤–µ—Ç—á–∏–∫: –ü—Ä–∏–Ω—è—Ç—å Offer –∏ —Å–æ–∑–¥–∞—Ç—å Answer</h3>
  <div class="row">
    <textarea id="offerIn" placeholder="–í—Å—Ç–∞–≤—å —Å—é–¥–∞ Offer –æ—Ç –∑–≤–æ–Ω—è—â–µ–≥–æ..."></textarea>
    <button id="acceptOffer">‚úÖ –ü—Ä–∏–Ω—è—Ç—å Offer</button>
    <button id="copyAnswer">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Answer</button>
  </div>
  <textarea id="answerOut" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è Answer JSON (–æ—Ç–ø—Ä–∞–≤—å –∑–≤–æ–Ω—è—â–µ–º—É)"></textarea>

  <hr>

  <h3>3Ô∏è‚É£ –ó–≤–æ–Ω—è—â–∏–π: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Answer</h3>
  <div class="row">
    <textarea id="answerIn" placeholder="–í—Å—Ç–∞–≤—å —Å—é–¥–∞ Answer –æ—Ç –¥—Ä—É–≥–∞..."></textarea>
    <button id="setAnswerBtn">üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Answer</button>
  </div>

  <div id="remoteAudioHolder"></div>

<script>
(async () => {
  const pcConfig = {
    iceServers: [
      { urls: ["stun:stun.l.google.com:19302", "stun:stun1.l.google.com:19302"] },
      { urls: ["stun:stun.services.mozilla.com"] }
    ]
  };

  let pc = null;
  let localStream = null;
  let localCandidates = [];
  let remoteAudioHolder = document.getElementById('remoteAudioHolder');

  function createPeerConnection() {
    pc = new RTCPeerConnection(pcConfig);
    localCandidates = [];

    pc.ontrack = (e) => {
      remoteAudioHolder.innerHTML = "";
      const audio = document.createElement('audio');
      audio.autoplay = true;
      audio.controls = true;
      audio.srcObject = e.streams[0];
      remoteAudioHolder.appendChild(document.createTextNode('üéß –ü–æ–ª—É—á–∞–µ–º –∞—É–¥–∏–æ:'));
      remoteAudioHolder.appendChild(audio);
    };

    pc.onicecandidate = (e) => {
      if (e.candidate) {
        localCandidates.push(e.candidate.toJSON());
      }
    };

    return pc;
  }

  async function ensureMic() {
    if (!localStream) {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        document.getElementById('micStatus').textContent = "üü¢ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω";
        document.getElementById('startMic').disabled = true;
      } catch (err) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω: " + err.message);
        throw err;
      }
    }
  }

  function waitForIceGatheringComplete(pc, timeout = 7000) {
    return new Promise(resolve => {
      if (pc.iceGatheringState === 'complete') return resolve();
      function check() {
        if (pc.iceGatheringState === 'complete') {
          pc.removeEventListener('icegatheringstatechange', check);
          resolve();
        }
      }
      pc.addEventListener('icegatheringstatechange', check);
      setTimeout(() => {
        pc.removeEventListener('icegatheringstatechange', check);
        resolve();
      }, timeout);
    });
  }

  async function addLocalTracks(pc) {
    if (!localStream) return;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  // –°–æ–∑–¥–∞—Ç—å Offer
  document.getElementById('createOffer').onclick = async () => {
    try {
      await ensureMic();
      createPeerConnection();
      await addLocalTracks(pc);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await waitForIceGatheringComplete(pc);
      const payload = {
        sdp: pc.localDescription,
        candidates: localCandidates
      };
      document.getElementById('offerOut').value = JSON.stringify(payload, null, 2);
      alert("‚úÖ Offer –≥–æ—Ç–æ–≤ ‚Äî —Å–∫–æ–ø–∏—Ä—É–π JSON –∏ –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É.");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Offer: " + err.message);
      console.error(err);
    }
  };

  document.getElementById('copyOffer').onclick = () => {
    navigator.clipboard.writeText(document.getElementById('offerOut').value)
      .then(() => alert("üìã Offer —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"))
      .catch(err => alert("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: " + err));
  };

  // –ü—Ä–∏–Ω—è—Ç—å Offer –∏ —Å–æ–∑–¥–∞—Ç—å Answer
  document.getElementById('acceptOffer').onclick = async () => {
    try {
      const txt = document.getElementById('offerIn').value.trim();
      if (!txt) { alert("‚ùå –í—Å—Ç–∞–≤—å Offer JSON."); return; }
      const offerObj = JSON.parse(txt);

      await ensureMic();
      createPeerConnection();
      await addLocalTracks(pc);

      await pc.setRemoteDescription(new RTCSessionDescription(offerObj.sdp));

      if (Array.isArray(offerObj.candidates)) {
        for (const c of offerObj.candidates) {
          try { await pc.addIceCandidate(new RTCIceCandidate(c)); }
          catch(e){ console.warn("addIceCandidate(offer):", e); }
        }
      }

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await waitForIceGatheringComplete(pc);
      const payload = {
        sdp: pc.localDescription,
        candidates: localCandidates
      };
      document.getElementById('answerOut').value = JSON.stringify(payload, null, 2);
      alert("‚úÖ Answer –≥–æ—Ç–æ–≤ ‚Äî –æ—Ç–ø—Ä–∞–≤—å –∑–≤–æ–Ω—è—â–µ–º—É!");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Answer: " + err.message);
      console.error(err);
    }
  };

  document.getElementById('copyAnswer').onclick = () => {
    navigator.clipboard.writeText(document.getElementById('answerOut').value)
      .then(() => alert("üìã Answer —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"))
      .catch(err => alert("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: " + err));
  };

  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Answer
  document.getElementById('setAnswerBtn').onclick = async () => {
    try {
      const txt = document.getElementById('answerIn').value.trim();
      if (!txt) { alert("‚ùå –í—Å—Ç–∞–≤—å Answer JSON."); return; }
      const answerObj = JSON.parse(txt);
      if (!pc) { alert("‚ùå –û—à–∏–±–∫–∞: —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ Offer (–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∑–≤–æ–Ω—è—â–µ–≥–æ)."); return; }

      await pc.setRemoteDescription(new RTCSessionDescription(answerObj.sdp));
      if (Array.isArray(answerObj.candidates)) {
        for (const c of answerObj.candidates) {
          try { await pc.addIceCandidate(new RTCIceCandidate(c)); }
          catch(e){ console.warn("addIceCandidate(answer):", e); }
        }
      }
      alert("‚úÖ Answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ Answer: " + err.message);
      console.error(err);
    }
  };

  // –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
  document.getElementById('startMic').onclick = async () => {
    try {
      await ensureMic();
    } catch(e){}
  };

})();
</script>
</body>
</html>
```

---

### ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
- **–®—Ä–∏—Ñ—Ç**: `Orbitron` ‚Äî —Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –∫–∏–±–µ—Ä–ø–∞–Ω–∫-—Å—Ç–∏–ª—å.
- **–¶–≤–µ—Ç–∞**: –Ω–µ–æ–Ω–æ–≤—ã–µ ‚Äî `#00ffcc`, `#00ffaa`, `#ff00ff`.
- **–°–≤–µ—á–µ–Ω–∏–µ**: `text-shadow`, `box-shadow` –¥–ª—è –∫–Ω–æ–ø–æ–∫, —Ç–µ–∫—Å—Ç–∞, –≥—Ä–∞–Ω–∏—Ü.
- **–ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –∏ —Ñ–æ–Ω**: —Ç—ë–º–Ω—ã–π —Å –ª–µ–≥–∫–∏–º —Å–µ—Ç—á–∞—Ç—ã–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º.
- **–ò–∫–æ–Ω–∫–∏**: –¥–æ–±–∞–≤–ª–µ–Ω—ã emoji (üé§, üìã, ‚úÖ, üîß, üåÄ).
- **–ê–Ω–∏–º–∞—Ü–∏–∏**: hover-—ç—Ñ—Ñ–µ–∫—Ç—ã, –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã.
- **UX**: —É–ª—É—á—à–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–∫–∏, —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

üìå **–¢–µ–ø–µ—Ä—å –≤–∞—à P2P-–∑–≤–æ–Ω–æ–∫ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –∏–∑ –±—É–¥—É—â–µ–≥–æ!**  
–†–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ ‚Äî –Ω–æ —Å –∫–æ—Å–º–∏—á–µ—Å–∫–∏–º —Å—Ç–∏–ª–µ–º üöÄ

> üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ß—Ç–æ–±—ã –µ—â—ë –±–æ–ª—å—à–µ —É–ª—É—á—à–∏—Ç—å UX, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`connecting`, `connected`, `failed`).
