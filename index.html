<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ZULFS Discord</title>
<style>
  body { margin:0; font-family:sans-serif; display:flex; height:100vh; background:#36393f; color:white; }
  .sidebar { width:250px; background:#2f3136; display:flex; flex-direction:column; }
  .server-name { padding:10px; font-weight:bold; font-size:18px; border-bottom:1px solid #40444b; }
  .channels { flex:1; overflow-y:auto; padding:5px; }
  .channel, .user { padding:5px; margin:2px 0; cursor:pointer; border-radius:3px; }
  .channel:hover, .user:hover { background:#40444b; }
  .main { flex:1; display:flex; flex-direction:column; padding:10px; }
  #messages { flex:1; overflow-y:auto; background:#2f3136; padding:5px; border-radius:5px; margin-bottom:5px; }
  #msgInput { flex:1; padding:5px; border:none; border-radius:3px; }
  #sendBtn { padding:5px 10px; margin-left:5px; border:none; border-radius:3px; background:#7289da; color:white; cursor:pointer; }
  .chat-input { display:flex; margin-bottom:5px; }
  .user-status { font-size:10px; margin-left:5px; }
  video { width:45%; margin:5px; background:black; border-radius:5px; }
  .call-btn { background:#43b581; border:none; color:white; padding:2px 5px; border-radius:3px; margin-left:5px; cursor:pointer; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="server-name">ZULFS</div>
  <div class="channels">
    <div><b>Каналы</b></div>
    <div class="channel">💬 Общий</div>
    <div class="channel">🎥 Видеочат</div>
    <div style="margin-top:10px;"><b>Пользователи</b></div>
    <div id="users"></div>
  </div>
</div>

<div class="main">
  <div id="messages"></div>
  <div class="chat-input">
    <input type="text" id="msgInput" placeholder="Написать сообщение...">
    <button id="sendBtn">Отправить</button>
  </div>
  <div style="display:flex;">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>
</div>

<script>
let nickname = prompt("Введите ник:");
let ws = new WebSocket("wss://orange-deer-allow.loca.lt"); // сюда свой wss
let localStream;
let pc;
const usersDiv = document.getElementById("users");
const messagesDiv = document.getElementById("messages");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

ws.onopen = ()=> ws.send(JSON.stringify({type:"join", nickname}));

ws.onmessage = event => {
  const data = JSON.parse(event.data);
  if(data.type==="users") {
    usersDiv.innerHTML = "";
    data.users.forEach(u=>{
      if(u.nickname!==nickname){
        const div = document.createElement("div");
        div.textContent = u.nickname;
        div.className = "user";
        const status = document.createElement("span");
        status.className = "user-status";
        status.textContent = u.online ? "🟢 online" : "⚪ offline";
        div.appendChild(status);
        const btn = document.createElement("button");
        btn.textContent = "📞";
        btn.className="call-btn";
        btn.onclick = ()=> startCall(u.nickname);
        div.appendChild(btn);
        usersDiv.appendChild(div);
      }
    });
  } else if(data.type==="message"){
    messagesDiv.innerHTML += `<b>${data.from}:</b> ${data.text}<br>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  } else if(data.type==="offer" || data.type==="answer" || data.type==="candidate"){
    handleWebRTC(data);
  }
};

// отправка сообщений
document.getElementById("sendBtn").onclick = ()=>{
  const text = document.getElementById("msgInput").value;
  ws.send(JSON.stringify({type:"message", text}));
  document.getElementById("msgInput").value="";
};

// WebRTC
async function initMedia(){
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;
}
async function startCall(targetNick){
  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
  pc.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({type:"candidate", candidate:e.candidate, to:targetNick})) };
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({type:"offer", offer, to:targetNick}));
}
async function handleWebRTC(data){
  if(!pc){
    pc = new RTCPeerConnection();
    localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
    pc.ontrack = e=>remoteVideo.srcObject=e.streams[0];
    pc.onicecandidate=e=>{ if(e.candidate) ws.send(JSON.stringify({type:"candidate", candidate:e.candidate, to:data.from})); };
  }
  if(data.type==="offer"){
    await pc.setRemoteDescription(data.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({type:"answer", answer, to:data.from}));
  } else if(data.type==="answer") await pc.setRemoteDescription(data.answer);
  else if(data.type==="candidate") await pc.addIceCandidate(data.candidate);
}

initMedia();
</script>
</body>
</html>
