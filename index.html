<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Zulfat Voice Chat</title>
<style>
  body { font-family: Arial; background: #222; color: #fff; text-align: center; }
  #login, #chat { margin-top: 50px; }
  input { padding: 10px; font-size: 16px; }
  button { padding: 10px; font-size: 16px; }
  ul { list-style: none; padding: 0; }
  li { margin: 5px 0; }
</style>
</head>
<body>

<div id="login">
  <h1>Введите имя</h1>
  <input type="text" id="username" placeholder="Имя">
  <button id="joinBtn">Войти в комнату</button>
</div>

<div id="chat" style="display:none;">
  <h1>Комната Zulfat</h1>
  <h3>Участники:</h3>
  <ul id="users"></ul>
  <audio id="remoteAudio" autoplay></audio>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "BGGMpn8F66tOHR2q8BJDwEQtpoAV-nxysmwpMyBQlPLVciyYFQm4MdeZmAyJa2oi_ByB8-Cq--fDBKcvg2OoqPc",
  authDomain: "zulfat-9615a.firebaseapp.com",
  databaseURL: "https://zulfat-9615a-default-rtdb.firebaseio.com",
  projectId: "zulfat-9615a",
  storageBucket: "zulfat-9615a.appspot.com",
  messagingSenderId: "399179660422",
  appId: "1:399179660422:web:e7bba9be2688ac49bf2507"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const joinBtn = document.getElementById("joinBtn");
const usernameInput = document.getElementById("username");
const loginDiv = document.getElementById("login");
const chatDiv = document.getElementById("chat");
const usersList = document.getElementById("users");
const remoteAudio = document.getElementById("remoteAudio");

let localStream;
let peers = {};
let username;

joinBtn.onclick = async () => {
  username = usernameInput.value.trim();
  if(!username) return alert("Введите имя!");
  loginDiv.style.display = "none";
  chatDiv.style.display = "block";

  // получаем микрофон
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  
  // добавляем себя в базу участников
  const userRef = db.ref("room/users/" + username);
  userRef.set(true);
  userRef.onDisconnect().remove();

  // слушаем список пользователей
  db.ref("room/users").on("value", snapshot => {
    usersList.innerHTML = "";
    snapshot.forEach(s => {
      const li = document.createElement("li");
      li.textContent = s.key + (s.key === username ? " (Вы)" : "");
      usersList.appendChild(li);
    });
  });

  // создаем peer connection для каждого нового пользователя
  db.ref("room/offers").on("child_added", async snap => {
    const data = snap.val();
    if(data.to !== username) return;
    const pc = new RTCPeerConnection();
    peers[data.from] = pc;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; };

    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    db.ref("room/answers/" + data.from + "_" + username).set({answer: answer});
  });

  db.ref("room/answers").on("child_added", async snap => {
    const key = snap.key;
    const [from, to] = key.split("_");
    if(to !== username) return;
    const pc = peers[from];
    if(!pc) return;
    await pc.setRemoteDescription(new RTCSessionDescription(snap.val().answer));
  });

  // инициируем соединение с уже подключенными
  db.ref("room/users").once("value").then(snapshot => {
    snapshot.forEach(async s => {
      if(s.key === username) return;
      const pc = new RTCPeerConnection();
      peers[s.key] = pc;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; };
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      db.ref("room/offers").push({from: username, to: s.key, offer: offer});
    });
  });
};
</script>
</body>
</html>
