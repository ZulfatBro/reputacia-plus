const WebSocket = require('ws');

// Запускаем локальный WebSocket сервер на 8080
const wss = new WebSocket.Server({ port: 8080 });
let users = [];

wss.on('connection', ws => {
  let nickname = '';

  ws.on('message', message => {
    const data = JSON.parse(message);

    if (data.type === 'join') {
      nickname = data.nickname;
      users.push({ ws, nickname });
      broadcastUsers();
    }

    // пересылаем оффер/ответ конкретному пользователю
    else if (data.type === 'offer' || data.type === 'answer' || data.type === 'candidate') {
      const target = users.find(u => u.nickname === data.to);
      if (target) {
        target.ws.send(JSON.stringify({ ...data, from: nickname }));
      }
    }
  });

  ws.on('close', () => {
    users = users.filter(u => u.ws !== ws);
    broadcastUsers();
  });

  function broadcastUsers() {
    const nicknames = users.map(u => u.nickname);
    users.forEach(u => u.ws.send(JSON.stringify({ type: 'users', users: nicknames })));
  }
});

console.log('✅ WebSocket сервер запущен на порту 8080');
