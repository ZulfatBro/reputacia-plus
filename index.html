<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P2P Call ‚Äî no servers</title>
<style>
  :root{
    --bg:#0b0f16; --panel:#0f1422; --panel2:#0b1020; --txt:#e6ebff; --muted:#8aa0c8;
    --blue:#3aa9ff; --violet:#8a5cff;
    --grad:linear-gradient(135deg, rgba(58,169,255,.9), rgba(138,92,255,.9));
    --br:14px; --bd:1px solid rgba(138,92,255,.25); --glow:0 8px 30px rgba(66,110,200,.35), inset 0 0 0 1px rgba(138,92,255,.15);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1000px 600px at 15% -10%, rgba(138,92,255,.12), transparent),
      radial-gradient(900px 600px at 110% 10%, rgba(58,169,255,.12), transparent),
      var(--bg);
    color:var(--txt); font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto;
  }
  .wrap{max-width:1100px; margin:28px auto; padding:18px}
  .brand{font-weight:900; font-size:24px; letter-spacing:.6px; background:var(--grad);
    -webkit-background-clip:text; background-clip:text; color:transparent; margin-bottom:2px}
  .muted{color:var(--muted)}
  .grid{display:grid; gap:14px; grid-template-columns: 1fr 1fr}
  .card{background:linear-gradient(180deg, rgba(16,22,40,.8), rgba(10,14,26,.9)); border-radius:var(--br);
    border:1px solid rgba(58,169,255,.12); box-shadow:var(--glow); padding:14px}
  h3{margin:0 0 10px 0; font-size:13px; letter-spacing:.12em; text-transform:uppercase; color:#b7c8ff}
  textarea, input{width:100%; background:var(--panel2); color:var(--txt); border:var(--bd); border-radius:10px; padding:10px 12px}
  textarea{min-height:160px; resize:vertical}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  button{background:var(--panel); color:var(--txt); border:var(--bd); border-radius:10px; padding:10px 12px; cursor:pointer}
  button.cta{background:var(--grad); border:none}
  button:active{transform:scale(.98)}
  .pill{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid rgba(58,169,255,.35); background:rgba(58,169,255,.12)}
  .columns{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
  .audio{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  audio{width:100%; background:#0002; border-radius:10px}
  .small{font-size:12px}
  .hint{font-size:12px; color:#b7c8ff}
  .footer{margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">P2P Call Mono</div>
  <div class="muted">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞ ‚Ä¢ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Å–∏–Ω–∏–µ/—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã ‚Ä¢ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤, –±–µ–∑ –ë–î ‚Äî –∑–≤–æ–Ω—è—â–∏–µ —Å–∞–º–∏ ¬´—Å–µ—Ä–≤–µ—Ä—ã¬ª</div>

  <div class="grid" style="margin-top:14px">
    <div class="card">
      <h3>1) –ú–∏–∫—Ä–æ—Ñ–æ–Ω</h3>
      <div class="row">
        <button class="cta" id="btnMic">üéôÔ∏è –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <button id="btnMute" disabled>üîá –ú—å—é—Ç</button>
        <span class="pill" id="micState">–≤—ã–∫–ª</span>
      </div>
      <div class="audio" style="margin-top:10px">
        <div style="flex:1">
          <div class="hint">–í–∞—à –≥–æ–ª–æ—Å (–ª–æ–∫–∞–ª—å–Ω–æ):</div>
          <audio id="localAudio" autoplay muted></audio>
        </div>
        <div style="flex:1">
          <div class="hint">–ü–∞—Ä—Ç–Ω—ë—Ä:</div>
          <audio id="remoteAudio" autoplay></audio>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–≤–æ–π STUN</h3>
      <div class="row">
        <input id="stunUrl" placeholder="–ø—Ä–∏–º–µ—Ä: stun:stun.l.google.com:19302 (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º ‚Äî –≤–æ–æ–±—â–µ –±–µ–∑ STUN)"/>
        <button id="applyStun">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div class="small muted">–ë–µ–∑ STUN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —á–∞—â–µ –≤—Å–µ–≥–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏ / —Å –±–µ–ª—ã–º–∏ IP. –≠—Ç–æ –ø–æ –≤–∞—à–µ–º—É –∂–µ–ª–∞–Ω–∏—é ‚Äî —Å–∞–π—Ç –Ω–∏—á–µ–≥–æ –Ω–µ ¬´–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç¬ª.</div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h3>2) –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (—Ä—É—á–Ω–æ–π –æ–±–º–µ–Ω SDP ‚Äî –±–µ–∑ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)</h3>
    <div class="columns">
      <div>
        <div class="hint">–í—ã ‚Äî –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä (A)</div>
        <div class="row" style="margin-top:6px">
          <button class="cta" id="btnCreateOffer">–°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</button>
          <button id="btnCopyOffer">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</button>
          <span class="pill" id="offerState">–Ω–µ—Ç</span>
        </div>
        <textarea id="offerOut" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≤–∞—à –æ—Ñ—Ñ–µ—Ä (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–∞—Ä—Ç–Ω—ë—Ä—É)"></textarea>

        <div class="row" style="margin-top:8px">
          <button id="btnSetAnswer">–í—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç (Answer) –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <span class="pill" id="answerState">–Ω–µ –ø—Ä–∏–º–µ–Ω—ë–Ω</span>
        </div>
        <textarea id="answerIn" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ Answer –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ø—Ä–∏–º–µ–Ω–∏—Ç—å¬ª"></textarea>
      </div>

      <div>
        <div class="hint">–í—ã ‚Äî –ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π (B)</div>
        <div class="row" style="margin-top:6px">
          <button id="btnSetOffer">–í—Å—Ç–∞–≤–∏—Ç—å –æ—Ñ—Ñ–µ—Ä (Offer) –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <span class="pill" id="setOfferState">–Ω–µ –ø—Ä–∏–º–µ–Ω—ë–Ω</span>
        </div>
        <textarea id="offerIn" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ Offer –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ø—Ä–∏–º–µ–Ω–∏—Ç—å¬ª"></textarea>

        <div class="row" style="margin-top:8px">
          <button class="cta" id="btnCreateAnswer">–°–æ–∑–¥–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
          <button id="btnCopyAnswer">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
          <span class="pill" id="madeAnswerState">–Ω–µ—Ç</span>
        </div>
        <textarea id="answerOut" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≤–∞—à Answer (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É)"></textarea>
      </div>
    </div>

    <div class="footer row">
      <button id="btnHangup">‚õî –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
      <span class="pill" id="connState">disconnected</span>
      <span class="pill" id="iceState">ice: new</span>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h3>–ú–∏–Ω–∏-—á–∞—Ç (—á–µ—Ä–µ–∑ DataChannel ‚Äî p2p)</h3>
    <div class="row">
      <input id="chatInput" placeholder="—Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶ (–ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)"/>
      <button id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <textarea id="chatLog" readonly placeholder="–õ–æ–≥ —á–∞—Ç–∞" style="min-height:120px; margin-top:8px"></textarea>
  </div>
</div>

<script>
  // === –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π P2P WebRTC –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞: –æ–±–º–µ–Ω SDP –≤—Ä—É—á–Ω—É—é ===
  let pc = null;
  let localStream = null;
  let dc = null; // data channel
  let iceServers = []; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ë–ï–ó STUN/TURN

  const qs = id => document.getElementById(id);
  const $micState = qs('micState');
  const $offerOut = qs('offerOut');
  const $answerOut = qs('answerOut');
  const $offerIn = qs('offerIn');
  const $answerIn = qs('answerIn');
  const $connState = qs('connState');
  const $iceState = qs('iceState');
  const $localAudio = qs('localAudio');
  const $remoteAudio = qs('remoteAudio');
  const $chatLog = qs('chatLog');

  function logChat(s){ $chatLog.value += s + "\n"; $chatLog.scrollTop = $chatLog.scrollHeight; }

  function createPC(){
    if (pc) return pc;
    pc = new RTCPeerConnection({ iceServers, iceCandidatePoolSize: 0 });
    pc.onconnectionstatechange = ()=>{ $connState.textContent = pc.connectionState || 'unknown'; };
    pc.onicegatheringstatechange = ()=>{ $iceState.textContent = 'ice: ' + pc.iceGatheringState; };
    pc.oniceconnectionstatechange = ()=>{ $iceState.textContent = 'ice: ' + pc.iceConnectionState; };
    pc.ontrack = (ev)=>{ $remoteAudio.srcObject = ev.streams[0]; };
    pc.ondatachannel = (ev)=>{
      dc = ev.channel;
      hookDC();
    };
    if (localStream){
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    }
    return pc;
  }

  function hookDC(){
    if (!dc) return;
    dc.onopen = ()=> logChat('üü¢ data channel open');
    dc.onclose = ()=> logChat('üî¥ data channel closed');
    dc.onmessage = (ev)=> logChat('–ü–∞—Ä—Ç–Ω—ë—Ä: ' + ev.data);
  }

  function waitIceComplete(peer){
    return new Promise(resolve=>{
      if (peer.iceGatheringState === 'complete') return resolve();
      const check = ()=>{ if (peer.iceGatheringState === 'complete'){ peer.removeEventListener('icegatheringstatechange', check); resolve(); } };
      peer.addEventListener('icegatheringstatechange', check);
      // —Ç–∞–∫–∂–µ –¥–æ–∂–¥—ë–º—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ null-candidate
      peer.onicecandidate = (e)=>{ if (!e.candidate) resolve(); };
    });
  }

  // === –ú–∏–∫—Ä–æ—Ñ–æ–Ω ===
  qs('btnMic').onclick = async ()=>{
    if (localStream) return;
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      $localAudio.srcObject = localStream;
      $micState.textContent = '–≤–∫–ª';
      qs('btnMute').disabled = false;
      if (pc){
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      }
    }catch(e){
      alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + e.message);
    }
  };
  qs('btnMute').onclick = ()=>{
    if (!localStream) return;
    const track = localStream.getAudioTracks()[0];
    track.enabled = !track.enabled;
    qs('btnMute').textContent = track.enabled ? 'üîá –ú—å—é—Ç' : 'üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
    $micState.textContent = track.enabled ? '–≤–∫–ª' : '–º—å—é—Ç';
  };

  // === STUN ===
  qs('applyStun').onclick = ()=>{
    const url = qs('stunUrl').value.trim();
    iceServers = url ? [{urls: url}] : [];
    alert('STUN –æ–±–Ω–æ–≤–ª—ë–Ω. –û–Ω —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.');
  };

  // === –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä (A) ===
  qs('btnCreateOffer').onclick = async ()=>{
    const peer = createPC();
    // –°–æ–∑–¥–∞–¥–∏–º data channel –¥–ª—è –º–∏–Ω–∏-—á–∞—Ç–∞
    dc = peer.createDataChannel('chat');
    hookDC();
    const offer = await peer.createOffer({ offerToReceiveAudio: true });
    await peer.setLocalDescription(offer);
    await waitIceComplete(peer); // –±–µ–∑ —Ç—Ä–∏–∫–ª-ICE: –æ–¥–∏–Ω SDP –±–ª–æ–∫
    $offerOut.value = JSON.stringify(peer.localDescription);
    qs('offerState').textContent = '—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω';
  };
  qs('btnCopyOffer').onclick = async ()=>{
    if (!$offerOut.value) return;
    await navigator.clipboard.writeText($offerOut.value);
  };
  qs('btnSetAnswer').onclick = async ()=>{
    try{
      const sdp = JSON.parse($answerIn.value.trim());
      await createPC().setRemoteDescription(sdp);
      qs('answerState').textContent = '–ø—Ä–∏–º–µ–Ω—ë–Ω';
    }catch(e){ alert('–û—à–∏–±–∫–∞ Answer: ' + e.message); }
  };

  // === –ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π (B) ===
  qs('btnSetOffer').onclick = async ()=>{
    try{
      const offer = JSON.parse($offerIn.value.trim());
      const peer = createPC();
      await peer.setRemoteDescription(offer);
      qs('setOfferState').textContent = '–ø—Ä–∏–º–µ–Ω—ë–Ω';
    }catch(e){ alert('–û—à–∏–±–∫–∞ Offer: ' + e.message); }
  };
  qs('btnCreateAnswer').onclick = async ()=>{
    const peer = createPC();
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    await waitIceComplete(peer);
    $answerOut.value = JSON.stringify(peer.localDescription);
    qs('madeAnswerState').textContent = '–≥–æ—Ç–æ–≤';
  };
  qs('btnCopyAnswer').onclick = async ()=>{
    if (!$answerOut.value) return;
    await navigator.clipboard.writeText($answerOut.value);
  };

  // === –ß–∞—Ç ===
  qs('chatSend').onclick = ()=>{
    const input = qs('chatInput');
    const text = input.value.trim();
    if (!text) return;
    if (dc && dc.readyState === 'open'){
      dc.send(text);
      logChat('–í—ã: ' + text);
      input.value = '';
    } else {
      alert('–ö–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –µ—â—ë –Ω–µ –æ—Ç–∫—Ä—ã—Ç (–Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ).');
    }
  };

  // === –†–∞–∑—Ä—ã–≤ ===
  qs('btnHangup').onclick = ()=>{
    if (pc){
      try{ pc.getSenders().forEach(s=>s.track && s.track.stop()); }catch(e){}
      try{ pc.close(); }catch(e){}
    }
    pc = null; dc = null;
    $connState.textContent = 'disconnected';
    $iceState.textContent = 'ice: new';
  };
</script>
</body>
</html>
