<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Zulfat Voice Chat</title>
</head>
<body>
<h1>Zulfat Voice Chat</h1>
<button id="start">Начать чат</button>
<audio id="remoteAudio" autoplay></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // === Firebase config ===
  const firebaseConfig = {
    apiKey: "BGGMpn8F66tOHR2q8BJDwEQtpoAV-nxysmwpMyBQlPLVciyYFQm4MdeZmAyJa2oi_ByB8-Cq--fDBKcvg2OoqPc",
    authDomain: "zulfat-9615a.firebaseapp.com",
    databaseURL: "https://zulfat-9615a-default-rtdb.firebaseio.com",
    projectId: "zulfat-9615a",
    storageBucket: "zulfat-9615a.appspot.com",
    messagingSenderId: "399179660422",
    appId: "1:399179660422:web:e7bba9be2688ac49bf2507"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const startButton = document.getElementById("start");
  const remoteAudio = document.getElementById("remoteAudio");

  let pc, localStream;
  const roomId = "zulfatRoom"; // Можно менять для разных комнат
  const roomRef = db.ref("rooms/" + roomId);

  startButton.onclick = async () => {
    startButton.disabled = true;

    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = event => {
      remoteAudio.srcObject = event.streams[0];
    };

    pc.onicecandidate = event => {
      if (event.candidate) {
        roomRef.child("candidates").push(JSON.stringify(event.candidate));
      }
    };

    // Слушаем входящие сигналы
    roomRef.child("offer").once("value", async snap => {
      const offer = snap.val();
      if (!offer) {
        // Я создаю оффер
        const offerDesc = await pc.createOffer();
        await pc.setLocalDescription(offerDesc);
        roomRef.child("offer").set(JSON.stringify(offerDesc));

        // Жду answer
        roomRef.child("answer").on("value", async snap => {
          const answer = snap.val();
          if (answer) {
            await pc.setRemoteDescription(JSON.parse(answer));
          }
        });
      } else {
        // Я принимаю оффер
        await pc.setRemoteDescription(JSON.parse(offer));
        const answerDesc = await pc.createAnswer();
        await pc.setLocalDescription(answerDesc);
        roomRef.child("answer").set(JSON.stringify(answerDesc));
      }
    });

    // Слушаем кандидатов
    roomRef.child("candidates").on("child_added", snap => {
      const candidate = JSON.parse(snap.val());
      pc.addIceCandidate(new RTCIceCandidate(candidate));
    });
  };
</script>
</body>
</html>
