<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>🎥 WebRTC Видеочат</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; text-align:center; }
    video { width: 300px; margin: 10px; background:#000; }
    #users { margin-top:10px; }
  </style>
</head>
<body>
  <h1>🎥 WebRTC Видеочат</h1>
  <input id="nickname" placeholder="Ваш ник">
  <button onclick="join()">Войти</button>

  <div id="users"></div>
  <div>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

<script>
let ws;
let pc;
let localStream;
let nickname = '';

async function join(){
  nickname = document.getElementById('nickname').value;
  if (!nickname) return alert("Введите ник!");

  const SERVER_URL = prompt("Вставьте адрес WebSocket (wss://...loca.lt):", "wss://");
  if (!SERVER_URL) return;

  ws = new WebSocket(SERVER_URL);

  ws.onopen = () => {
    log("✅ Подключено к серверу");
    ws.send(JSON.stringify({ type:'join', nickname }));
  };

  ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'users') {
      renderUsers(data.users);
    }
    else if (data.type === 'offer') {
      await createPeerConnection();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ type:'answer', answer, to:data.from }));
    }
    else if (data.type === 'answer') {
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
    else if (data.type === 'candidate') {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      } catch (err) {
        console.error("Ошибка ICE:", err);
      }
    }
  };
}

function renderUsers(users){
  const div = document.getElementById('users');
  div.innerHTML = "Пользователи:<br>" + users.map(u => {
    if (u === nickname) return `<b>${u}</b>`;
    return `<button onclick="call('${u}')">Позвонить ${u}</button>`;
  }).join("<br>");
}

async function call(user){
  await createPeerConnection();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ type:'offer', offer, to:user }));
}

async function createPeerConnection(){
  pc = new RTCPeerConnection();

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      ws.send(JSON.stringify({ type:'candidate', candidate:e.candidate, to:getOtherUser() }));
    }
  };

  pc.ontrack = (e) => {
    document.getElementById('remoteVideo').srcObject = e.streams[0];
  };

  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  document.getElementById('localVideo').srcObject = localStream;
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
}

function getOtherUser(){
  const buttons = document.querySelectorAll("#users button");
  if (buttons.length > 0) {
    return buttons[0].textContent.replace("Позвонить ","");
  }
  return null;
}

function log(msg){
  console.log(msg);
}
</script>
</body>
</html>
