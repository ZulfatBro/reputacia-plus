<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç Zulfat</title>
<style>
  body { font-family: Arial; background: #111; color: #fff; text-align: center; padding: 20px; }
  button { margin: 10px; padding: 10px 20px; }
  audio { margin-top: 20px; }
</style>
</head>
<body>
  <h1>üî• –ú–∏–Ω–∏-–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç Zulfat</h1>
  <button id="startCall">–ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</button>
  <button id="endCall">–ó–∞–∫–æ–Ω—á–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
  <script>
    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "BGGMpn8F66tOHR2q8BJDwEQtpoAV-nxysmwpMyBQlPLVciyYFQm4MdeZmAyJa2oi_ByB8-Cq--fDBKcvg2OoqPc",
      authDomain: "zulfat-9615a.firebaseapp.com",
      databaseURL: "https://zulfat-9615a-default-rtdb.firebaseio.com",
      projectId: "zulfat-9615a",
      storageBucket: "zulfat-9615a.appspot.com",
      messagingSenderId: "399179660422",
      appId: "1:399179660422:web:e7bba9be2688ac49bf2507"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const startBtn = document.getElementById('startCall');
    const endBtn = document.getElementById('endCall');
    const remoteAudio = document.getElementById('remoteAudio');

    let pc; // PeerConnection
    let localStream;
    let roomId;

    async function startCall() {
      startBtn.disabled = true;

      // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      
      // –°–æ–∑–¥–∞–µ–º RTCPeerConnection
      pc = new RTCPeerConnection();

      // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ —Ç—Ä–µ–∫
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫
      pc.ontrack = (event) => {
        remoteAudio.srcObject = event.streams[0];
      };

      // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
      pc.onicecandidate = event => {
        if (event.candidate) {
          db.ref('rooms/' + roomId + '/candidates').push(event.candidate.toJSON());
        }
      };

      // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É
      roomId = 'room'; // –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ –≤—Å–µ–≥–¥–∞ –æ–¥–Ω–∞ –∫–æ–º–Ω–∞—Ç–∞
      const roomRef = db.ref('rooms/' + roomId);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ñ—Ñ–µ—Ä –≤ Firebase
      await roomRef.child('offer').set(offer.toJSON());

      // –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞
      roomRef.child('answer').on('value', async snapshot => {
        const answer = snapshot.val();
        if (answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      // –ñ–¥–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
      roomRef.child('candidates').on('child_added', snapshot => {
        const data = snapshot.val();
        pc.addIceCandidate(new RTCIceCandidate(data));
      });
    }

    async function endCall() {
      if (pc) pc.close();
      pc = null;
      remoteAudio.srcObject = null;
      startBtn.disabled = false;
    }

    endBtn.onclick = endCall;
    startBtn.onclick = startCall;
  </script>
</body>
</html>
